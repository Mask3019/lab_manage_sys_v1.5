{% extends 'base.html' %}
{% load static %}

{% block content %}

<main class="main">

    <!-- Page Title -->
    <div class="page-title dark-background" style="background-image: url({% static 'images/ban4.png' %});">
        <div class="container position-relative">
            <h1>{{ page_title }}</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a href="/">é¦–é¡µ</a></li>
                    <li class="current"><a href="{% url 'experiment:experiment_tasks_day' %}">è¯•éªŒç®¡ç† / </a>{{ page_title }}</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Starter Section Section -->
    <section id="starter-section" class="starter-section section">
        <div class="container" data-aos="fade-up">
             <!-- æ§ä»¶å¡ç‰‡ -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-center">
                        {% if user_has_permission %}
                            <button id="add-row" class="btn btn-primary me-3 mb-2">æ–°å¢ä»»åŠ¡</button>
                        {% endif %}
                        <input type="date" id="filter-date" class="form-control me-3 mb-2" style="max-width: 180px;">
                        <div class="form-check form-check-inline me-3 mb-2">
                            <input class="form-check-input" type="radio" name="date-range" id="this-week" value="week">
                            <label class="form-check-label" for="this-week">æŸ¥çœ‹æœ¬å‘¨</label>
                        </div>
                        <div class="form-check form-check-inline me-3 mb-2">
                            <input class="form-check-input" type="radio" name="date-range" id="this-month" value="month">
                            <label class="form-check-label" for="this-month">æŸ¥çœ‹æœ¬æœˆ</label>
                        </div>
                        <div class="form-check form-check-inline me-3 mb-2">
                            <input class="form-check-input" type="radio" name="date-range" id="this-year" value="year">
                            <label class="form-check-label" for="this-year">æŸ¥çœ‹æœ¬å¹´</label>
                        </div>
                        <input type="text" id="search-input" class="form-control mb-2" placeholder="æœç´¢..." style="max-width: 200px;">
                    </div>
                </div>
            </div>
             <!-- è¡¨æ ¼ -->
            <div class="card">
                <table id="task-table" class="table table-bordered table-striped mb-0" style="width: 100%;"> <!-- è®¾ç½®è¡¨æ ¼å®½åº¦ä¸º100% -->
                    <thead style="position: sticky; top: 0; background: white; z-index: 1;"> <!-- å›ºå®šè¡¨å¤´ -->
                        <tr>
                            <th style="text-align: center;width: 3%;">åºå·</th>
                            <th style="text-align: center;width: 5%;">ä»»åŠ¡å•å·</th>
                            <th style="text-align: center;width: 6%;">ä»»åŠ¡çŠ¶æ€</th>
                            <th style="text-align: center;width: 6%;">é¡¹ç›®ä»£å·</th>
                            <th style="text-align: center;width: 10%;">æ ·å“ç¼–å·</th>
                            <th style="text-align: center;width: 8%;">è¯•éªŒå†…å®¹</th>
                            <th style="text-align: center;width: 12%;">è¯•éªŒå¤§çº²</th>
                            <th style="text-align: center;width: 7%;">è®¾å¤‡ç¼–å·</th>
                            <th style="text-align: center;width: 6%;">ä»»åŠ¡æ—¥æœŸ</th>
                            <th style="text-align: center;width: 5%;">å§”æ‰˜äºº</th>
                            <th style="text-align: center;width: 5%;">è¯•éªŒäººå‘˜</th> <!-- å§‹ç»ˆä¸å¯ç¼–è¾‘ -->
                            <th style="text-align: center;width: 3%;">è¿›åº¦</th> <!-- å§‹ç»ˆä¸å¯ç¼–è¾‘ -->
                            <th style="text-align: center;width: 12%;">å¤‡æ³¨</th>
                            {% if user_has_permission %}
                            <th style="text-align: center;width: 7%;">æ“ä½œ</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ task.task_id }}</td>
                            <td>
                                {{ task.task_status }}
                            </td>
                            <td>{{ task.project }}</td>
                            <td>{{ task.sample_id }}</td>
                            <td>{{ task.test_content }}</td>
                            <td>
                                {{ task.outline }}
                            </td>
                            <td>{{ task.equipment_id }}</td>
                            <td>{{ task.task_date|date:"Y-m-d" }}</td>
                            <td>{{ task.client }}</td>
                            <td>{{ task.experimenter }}</td> <!-- å§‹ç»ˆä¸å¯ç¼–è¾‘ -->
                            <td>{{ task.schedule }}</td> <!-- å§‹ç»ˆä¸å¯ç¼–è¾‘ -->
                            <td>{{ task.remark }}</td>

                            {% if user_has_permission %}
                            <td>
                                <button class="btn btn-sm btn-info edit-btn">ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-danger delete-btn">åˆ é™¤</button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<!-- ä»»åŠ¡é€‰æ‹©æ¨¡æ€çª—å£ -->
<div class="modal fade" id="taskSelectionModal" tabindex="-1" aria-labelledby="taskSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-white" id="taskSelectionModalLabel">ğŸ“‹ é€‰æ‹©ä»»åŠ¡å§”æ‰˜å•</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group" style="width: 33%;">
                        <span class="input-group-text">ğŸ”</span>
                        <input type="text" id="task-search-input" class="form-control" placeholder="è¾“å…¥ä»»åŠ¡å•å·æˆ–é¡¹ç›®ä»£å·æœç´¢...">
                        <button class="btn btn-primary" id="task-search-btn">æœç´¢</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="task-application-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">ä»»åŠ¡å•å·</th>
                                <th style="width: 15%">é¡¹ç›®ä»£å·</th>
                                <th style="width: 15%">æ ·å“ç¼–å·</th>
                                <th style="width: 25%">è¯•éªŒå†…å®¹</th>
                                <th style="width: 20%">è¯•éªŒå¤§çº²</th>
                                <th style="width: 10%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

{% if error_message %}
<script>
    alert("{{ error_message }}");
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM fully loaded and parsed');

         // è·å–å½“å‰æ—¥æœŸ
        const today = new Date();

    // è®¾ç½®æ—¥æœŸç­›é€‰æ§ä»¶çš„é»˜è®¤å€¼ä¸ºå½“å‰æ—¥æœŸ
    document.getElementById('filter-date').value = today.toISOString().split('T')[0];

    // æ—¥æœŸç­›é€‰åŠŸèƒ½
    function filterByDate() {
        let selectedDate = document.getElementById('filter-date').value;
        let rows = document.querySelectorAll('#task-table tbody tr');
        rows.forEach(row => {
            let taskDateStr = row.cells[8].innerText.trim();
            let taskDate = new Date(taskDateStr);  // è½¬æ¢ä»»åŠ¡æ—¥æœŸä¸º Date å¯¹è±¡

            if (taskDate.toISOString().split('T')[0] === selectedDate || !selectedDate) {
                row.style.display = '';  // æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œ
            } else {
                row.style.display = 'none';  // éšè—ä¸ç¬¦åˆæ¡ä»¶çš„è¡Œ
            }
        });
    }

    // è·å–æœ¬å‘¨ã€æœ¬æœˆã€æœ¬å¹´çš„èµ·å§‹æ—¥æœŸ
    function getStartOfPeriod(period) {
        const date = new Date();  // è·å–å½“å‰æ—¥æœŸå¯¹è±¡
        switch (period) {
            case 'week':
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.setDate(diff));  // è¿”å›æœ¬å‘¨çš„èµ·å§‹æ—¥æœŸå¯¹è±¡
            case 'month':
                return new Date(date.getFullYear(), date.getMonth(), 1);  // è¿”å›æœ¬æœˆçš„èµ·å§‹æ—¥æœŸå¯¹è±¡
            case 'year':
                return new Date(date.getFullYear(), 0, 1);  // è¿”å›ä»Šå¹´çš„èµ·å§‹æ—¥æœŸå¯¹è±¡
            default:
                return today;  // é»˜è®¤ä¸ºä»Šå¤©
        }
    }

    // é€šè¿‡å•é€‰æŒ‰é’®ç­›é€‰æ•°æ®
    function filterByPeriod(period) {
        let startDate = getStartOfPeriod(period);  // è·å–æ—¶é—´æ®µçš„èµ·å§‹æ—¥æœŸ

        console.log(`Filtering data from ${startDate.toISOString().split('T')[0]} to ${today.toISOString().split('T')[0]}`);

        let rows = document.querySelectorAll('#task-table tbody tr');
        rows.forEach(row => {
            let taskDateStr = row.cells[8].innerText.trim();
            let taskDate = new Date(taskDateStr);  // å°†ä»»åŠ¡æ—¥æœŸè½¬æ¢ä¸º Date å¯¹è±¡

            // åªæ¯”è¾ƒæ—¥æœŸçš„ YYYY-MM-DD éƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´éƒ¨åˆ†
            let taskDateOnly = taskDate.toISOString().split('T')[0];  // åªå– YYYY-MM-DD éƒ¨åˆ†
            let startDateOnly = startDate.toISOString().split('T')[0];  // åªå– YYYY-MM-DD éƒ¨åˆ†
            let todayOnly = today.toISOString().split('T')[0];  // åªå– YYYY-MM-DD éƒ¨åˆ†

            // æ¯”è¾ƒä»»åŠ¡æ—¥æœŸæ˜¯å¦åœ¨æ—¶é—´æ®µå†…ï¼Œå¿½ç•¥æ—¶é—´éƒ¨åˆ†
            if (taskDateOnly >= startDateOnly && taskDateOnly <= todayOnly) {
                row.style.display = '';  // æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œ
            } else {
                row.style.display = 'none';  // éšè—ä¸ç¬¦åˆæ¡ä»¶çš„è¡Œ
            }
        });
    }

    // ç›‘å¬æ—¥æœŸæ›´æ”¹äº‹ä»¶
    document.getElementById('filter-date').addEventListener('change', filterByDate);

    // ç›‘å¬å•é€‰æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('input[name="date-range"]').forEach(radio => {
        radio.addEventListener('change', function () {
            filterByPeriod(this.value);
            console.log(this.value);
        });
    });

    // åˆæ¬¡åŠ è½½æ—¶æ ¹æ®å½“å‰æ—¥æœŸè¿‡æ»¤è¡¨æ ¼æ•°æ®
    filterByDate();

        // æ•°æ®æ ¼å¼éªŒè¯å‡½æ•°
        function validateData(data) {
            const errors = [];

            // ä»»åŠ¡å•å·éªŒè¯
            if (!/^\d{8}-\d{2}$/.test(data.task_id)) {
                errors.push('ä»»åŠ¡å•å·æ ¼å¼ä¸å¯¹ï¼Œæ­£ç¡®æ ¼å¼å¦‚ï¼š20240813-01');
            }

            // æ—¥æœŸæ ¼å¼éªŒè¯
            if (!/^\d{4}-\d{2}-\d{2}$/.test(data.task_date)) {
                errors.push('ä»»åŠ¡æ—¥æœŸæ ¼å¼å¿…é¡»ä¸º "YYYY-MM-DD"');
            }

            return errors;
        }

        // è¡¨å•å†…å®¹éªŒè¯å‡½æ•°
        function validateFormFields(data) {
            const requiredFields = [
                { field: data.project, name: "é¡¹ç›®ä»£å·" },
                { field: data.sample_id, name: "æ ·å“ç¼–å·" },
                { field: data.test_content, name: "è¯•éªŒå†…å®¹" },
                { field: data.outline, name: "è¯•éªŒå¤§çº²" },
                { field: data.equipment_id, name: "è®¾å¤‡ç¼–å·" },
                { field: data.client, name: "å§”æ‰˜äºº" }
            ];

            const errors = [];
            requiredFields.forEach(item => {
                if (!item.field || item.field.trim() === '') {
                    errors.push(`${item.name}ä¸èƒ½ä¸ºç©º`);
                }
            });

            if (errors.length > 0) {
                alert(errors.join('\n'));
                return false;
            }

            return true;
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('search-input').addEventListener('keyup', function () {
            let searchValue = this.value.toLowerCase();
            let rows = document.querySelectorAll('#task-table tbody tr');
            rows.forEach(row => {
                let cells = Array.from(row.cells).map(cell => cell.innerText.toLowerCase());
                let match = cells.some(cellText => cellText.includes(searchValue));
                row.style.display = match ? '' : 'none';
            });
        });

        // ä»»åŠ¡ç”³è¯·æœç´¢ç›¸å…³åŠŸèƒ½
        function searchTaskApplications(query = '') {
            fetch(`/api/search-task-applications/?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#task-application-table tbody');
                    tableBody.innerHTML = '';
                    
                    if (data.tasks && data.tasks.length > 0) {
                        data.tasks.forEach(task => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="white-space: nowrap;">${task.task_number || ''}</td>
                                <td style="white-space: nowrap;">${task.project_code || ''}</td>
                                <td style="white-space: nowrap;">${task.sample_code || ''}</td>
                                <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${task.test_content || ''}</td>
                                <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${task.test_specs || ''}</td>
                                <td style="text-align: center;">
                                    <button class="btn btn-primary btn-sm select-task-btn">é€‰æ‹©</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">æœªæ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('æœç´¢ä»»åŠ¡å¤±è´¥:', error);
                    alert('æœç´¢ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
        }

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('task-search-btn').addEventListener('click', function() {
            const query = document.getElementById('task-search-input').value.trim();
            searchTaskApplications(query);
        });

        // å›è½¦é”®è§¦å‘æœç´¢
        document.getElementById('task-search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                searchTaskApplications(query);
            }
        });

        // å§”æ‰˜å•é€‰æ‹©äº‹ä»¶å§”æ‰˜ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€æ·»åŠ çš„æŒ‰é’®ï¼‰
        document.getElementById('task-application-table').addEventListener('click', function(e) {
            if (e.target.classList.contains('select-task-btn')) {
                const row = e.target.closest('tr');
                const taskNumber = row.cells[0].textContent;
                const projectCode = row.cells[1].textContent;
                const sampleCode = row.cells[2].textContent;
                const testContent = row.cells[3].textContent;
                const testSpecs = row.cells[4].textContent;
                
                // å…³é—­æ¨¡æ€çª—å£
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskSelectionModal'));
                modal.hide();
                
                // åœ¨ä¸»è¡¨æ ¼ä¸­åˆ›å»ºæ–°è¡Œå¹¶å¡«å……æ•°æ®
                createNewTaskRowFromApplication(taskNumber, projectCode, sampleCode, testContent, testSpecs);
            }
        });

        // æ ¹æ®ä»»åŠ¡ç”³è¯·åˆ›å»ºæ–°è¡Œ
        function createNewTaskRowFromApplication(taskNumber, projectCode, sampleCode, testContent, testSpecs) {
            let table = document.getElementById('task-table').getElementsByTagName('tbody')[0];
            let newRow = table.insertRow();
            
            // è·å–ä»Šå¤©çš„æ—¥æœŸæ ¼å¼ä¸ºYYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            
            newRow.innerHTML = `
                <td contenteditable="true"></td>     <!-- 0 åºå· -->
                <td contenteditable="true">${taskNumber}</td>     <!-- 1 ä»»åŠ¡å•å· -->
                <td>
                    <select class="table-select">
                        <option value="å¾…å®‰æ’" selected>å¾…å®‰æ’</option>
                        <option value="æ ·ä»¶è£…è°ƒ">æ ·ä»¶è£…è°ƒ</option>
                        <option value="æ ·ä»¶è¿è¡Œ">æ ·ä»¶è¿è¡Œ</option>
                        <option value="æ ·ä»¶æ’æŸ¥">æ ·ä»¶æ’æŸ¥</option>
                        <option value="è®¾å¤‡æ’æŸ¥">è®¾å¤‡æ’æŸ¥</option>
                        <option value="ä»»åŠ¡æš‚åœ">ä»»åŠ¡æš‚åœ</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    </select>
                </td> <!-- 2 ä»»åŠ¡çŠ¶æ€ -->
                <td contenteditable="true" class="project-code">${projectCode}</td>     <!-- 3 é¡¹ç›®ä»£å· -->
                <td contenteditable="true">${sampleCode}</td>     <!-- 4 æ ·å“ç¼–å· -->
                <td contenteditable="true">${testContent}</td>     <!-- 5 è¯•éªŒå†…å®¹ -->
                <td>
                    <select class="outline-select">
                        <option value="${testSpecs}" selected>${testSpecs}</option>
                    </select>
                </td>     <!-- 6 è¯•éªŒå¤§çº² -->
                <td contenteditable="true"></td>     <!-- 7 è®¾å¤‡ç¼–å· -->
                <td><input type="date" class="table-select" value="${today}"></td>  <!-- 8 ä»»åŠ¡æ—¥æœŸ -->
                <td contenteditable="true"></td>     <!-- 9 å§”æ‰˜äºº -->
                <td contenteditable="false"></td>    <!-- 10 è¯•éªŒäººå‘˜ -->
                <td contenteditable="false"></td>    <!-- 11 è¿›åº¦ -->
                <td contenteditable="true"></td>     <!-- 12 å¤‡æ³¨ -->
                <td>
                    <button class="btn btn-sm btn-success save-btn">ä¿å­˜</button>
                    <button class="btn btn-sm btn-secondary cancel-btn">å–æ¶ˆ</button>
                </td>`;
            
            // æ›´æ–°åºå·
            updateRowNumbers();
            
            // è·å–é¡¹ç›®ä»£å·å•å…ƒæ ¼å’Œè¯•éªŒå¤§çº²ä¸‹æ‹‰æ¡†
            let projectCodeCell = newRow.querySelector('.project-code');
            let outlineSelect = newRow.querySelector('.outline-select');

            // ä¸ºé¡¹ç›®ä»£å·æ·»åŠ bluräº‹ä»¶ï¼Œä»¥ä¾¿åœ¨ä¿®æ”¹æ—¶æ›´æ–°è¯•éªŒå¤§çº²é€‰é¡¹
            projectCodeCell.addEventListener('blur', function () {
                let projectCode = projectCodeCell.innerText.trim();
                if (projectCode) {
                    fetch(`/get_outlines/${projectCode}/`)
                        .then(response => response.json())
                        .then(data => {
                            outlineSelect.innerHTML = '<option value="">æ— å¤§çº²</option>';
                            data.outlines.forEach(outline => {
                                let optionText = `${outline.outline_num}/${outline.outline_name}`;
                                let selected = optionText === testSpecs ? 'selected' : '';
                                outlineSelect.innerHTML += `<option value="${optionText}" ${selected}>${optionText}</option>`;
                            });
                        })
                        .catch(error => {
                            console.error('è·å–è¯•éªŒå¤§çº²å¤±è´¥:', error);
                        });
                } else {
                    outlineSelect.innerHTML = '<option value="">æ— å¤§çº²</option>';
                }
            });
        }

        // æ›´æ–°æ‰€æœ‰è¡Œçš„åºå·
        function updateRowNumbers() {
            let rows = document.querySelectorAll('#task-table tbody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        // ä¿®æ”¹æ·»åŠ è¡ŒæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.getElementById('add-row').addEventListener('click', function () {
            // æ‰“å¼€æ¨¡æ€çª—å£
            const modal = new bootstrap.Modal(document.getElementById('taskSelectionModal'));
            modal.show();
            
            // åˆå§‹åŠ è½½ä»»åŠ¡åˆ—è¡¨
            searchTaskApplications();
        });

        // ç¼–è¾‘ã€ä¿å­˜ã€åˆ é™¤ã€å–æ¶ˆè¡Œ
        document.getElementById('task-table').addEventListener('click', function (event) {
            let target = event.target;

            if (target.classList.contains('edit-btn')) {
                let row = target.closest('tr');
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index !== 0 && index !== 10 && index !== 11 && index !== 13) { // Skip the first cell, 'è¯•éªŒäººå‘˜', 'è¿›åº¦', and action buttons
                        if (index === 2) { // ä»»åŠ¡çŠ¶æ€åˆ—
                            let currentValue = cell.textContent.trim();
                            cell.innerHTML = `<select class="table-select">
                                <option value="å¾…å®‰æ’" ${currentValue === "å¾…å®‰æ’" ? "selected" : ""}>å¾…å®‰æ’</option>
                                <option value="æ ·ä»¶è£…è°ƒ" ${currentValue === "æ ·ä»¶è£…è°ƒ" ? "selected" : ""}>æ ·ä»¶è£…è°ƒ</option>
                                <option value="æ ·ä»¶è¿è¡Œ" ${currentValue === "æ ·ä»¶è¿è¡Œ" ? "selected" : ""}>æ ·ä»¶è¿è¡Œ</option>
                                <option value="æ ·ä»¶æ’æŸ¥" ${currentValue === "æ ·ä»¶æ’æŸ¥" ? "selected" : ""}>æ ·ä»¶æ’æŸ¥</option>
                                <option value="è®¾å¤‡æ’æŸ¥" ${currentValue === "è®¾å¤‡æ’æŸ¥" ? "selected" : ""}>è®¾å¤‡æ’æŸ¥</option>
                                <option value="ä»»åŠ¡æš‚åœ" ${currentValue === "ä»»åŠ¡æš‚åœ" ? "selected" : ""}>ä»»åŠ¡æš‚åœ</option>
                                <option value="å·²å®Œæˆ" ${currentValue === "å·²å®Œæˆ" ? "selected" : ""}>å·²å®Œæˆ</option>
                            </select>`;
                        } else if (index === 6) { // è¯•éªŒå¤§çº²åˆ—
                            let currentProjectCodeCell = row.cells[3];
                            let currentProjectCode = currentProjectCodeCell.textContent.trim();
                            let currentOutline = cell.textContent.trim(); // è·å–å½“å‰æ˜¾ç¤ºçš„è¯•éªŒå¤§çº²
                            const updateOutlineOptions = () => {
                                if (currentProjectCode) {
                                    fetch(`/get_outlines/${currentProjectCode}/`)
                                        .then(response => {
                                            if (!response.ok) {
                                                throw new Error('Network response was not ok');
                                            }
                                            return response.json();
                                        })
                                        .then(data => {
                                            let outlineSelect = document.createElement('select');
                                            outlineSelect.classList.add('outline-select');
                                            outlineSelect.innerHTML = '<option value="">æ— å¤§çº²</option>';
                                            data.outlines.forEach(outline => {
                                                let optionText = `${outline.outline_num}/${outline.outline_name}`;
                                                let selected = optionText === currentOutline ? 'selected' : '';
                                                outlineSelect.innerHTML += `<option value="${optionText}" ${selected}>${optionText}</option>`;
                                            });
                                            cell.innerHTML = '';
                                            cell.appendChild(outlineSelect);
                                        })
                                        .catch(error => {
                                            console.error('Fetch error:', error);
                                        });
                                } else {
                                    console.error('é¡¹ç›®ä»£å·ä¸ºç©ºï¼Œæ— æ³•è·å–è¯•éªŒå¤§çº²æ•°æ®ã€‚');
                                }
                            };
                            updateOutlineOptions();

                            // æ·»åŠ é¡¹ç›®ä»£å·æ›´æ”¹äº‹ä»¶ç›‘å¬å™¨
                            currentProjectCodeCell.addEventListener('input', function () {
                                currentProjectCode = currentProjectCodeCell.textContent.trim();
                                updateOutlineOptions();
                            });
                        } else {
                            cell.contentEditable = true;
                        }
                    }
                });
                let taskDateCell = row.cells[8];
                let dateValue = taskDateCell.textContent.trim();
                taskDateCell.innerHTML = `<input type="date" class="table-select" value="${dateValue}">`; // Convert date cell to input field
                target.textContent = 'ä¿å­˜';
                target.classList.remove('edit-btn');
                target.classList.add('save-btn');
            } else if (target.classList.contains('save-btn')) {
                let row = target.closest('tr');
                let outlineSelect = row.cells[6].querySelector('select');
                let outlineText = outlineSelect ? outlineSelect.options[outlineSelect.selectedIndex].text.trim() : row.cells[6].innerText.trim();  // è·å–å®Œæ•´çš„é€‰å®šå€¼

                let data = {
                    task_id: row.cells[1].innerText.trim(),
                    task_status: row.cells[2].querySelector('select').value.trim(),
                    project: row.cells[3].innerText.trim(),
                    sample_id: row.cells[4].innerText.trim(),
                    test_content: row.cells[5].innerText.trim(),
                    outline: outlineText,  // ä¿å­˜å®Œæ•´çš„è¯•éªŒå¤§çº²å†…å®¹
                    equipment_id: row.cells[7].innerText.trim(),
                    task_date: row.cells[8].querySelector('input').value.trim(),  // ä»è¾“å…¥æ¡†è·å–ä»»åŠ¡æ—¥æœŸ
                    client: row.cells[9].innerText.trim(),
                    experimenter: row.cells[10].innerText.trim(),  // è¯•éªŒäººå‘˜ä¿æŒåŸæ ·
                    schedule: row.cells[11].innerText.trim(),  // è¿›åº¦ä¿æŒåŸæ ·
                    remark: row.cells[12].innerText.trim()
                };

                // éªŒè¯è¡¨å•å­—æ®µå†…å®¹æ˜¯å¦ä¸ºç©º
                if (!validateFormFields(data)) {
                    return;  // å¦‚æœéªŒè¯å¤±è´¥ï¼Œå–æ¶ˆä¿å­˜æ“ä½œ
                }

                console.log('Validating data:', data);

                // éªŒè¯æ•°æ®æ ¼å¼
                const errors = validateData(data);
                if (errors.length > 0) {
                    alert('ä¿å­˜å¤±è´¥:\n' + errors.join('\n'));
                    return;
                }

                // å¦‚æœéªŒè¯é€šè¿‡ï¼Œæ‰§è¡Œä¿å­˜æ“ä½œ
                $.ajax({
                    url: "{% url 'experiment:save_task' %}",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        console.log('ä¿å­˜æˆåŠŸ', response);
                        row.querySelectorAll('td').forEach((cell, index) => {
                            if (index !== 0 && index !== 10 && index !== 11 && index !== 13) { // Skip the first cell, 'è¯•éªŒäººå‘˜', 'è¿›åº¦', and action buttons
                                cell.contentEditable = false;
                            }
                        });
                        let taskDateCell = row.cells[8];
                        let dateValue = taskDateCell.querySelector('input').value;
                        taskDateCell.innerHTML = dateValue; // Convert input field back to text
                        // å°†ä»»åŠ¡çŠ¶æ€ä»ä¸‹æ‹‰æ¡†è¿˜åŸä¸ºæ–‡æœ¬
                        let taskStatusCell = row.cells[2];
                        let taskStatusValue = taskStatusCell.querySelector('select').value;
                        taskStatusCell.innerHTML = taskStatusValue; // å°†ä¸‹æ‹‰æ¡†å€¼è½¬æ¢ä¸ºæ–‡æœ¬
                        // å°†è¯•éªŒå¤§çº²ä»ä¸‹æ‹‰æ¡†è¿˜åŸä¸ºæ–‡æœ¬
                        let outlineCell = row.cells[6];
                        outlineCell.innerHTML = outlineText; // ä½¿ç”¨å®Œæ•´çš„è¯•éªŒå¤§çº²æ–‡æœ¬æ›´æ–°å•å…ƒæ ¼
                        target.textContent = 'ç¼–è¾‘';
                        target.classList.remove('save-btn');
                        target.classList.add('edit-btn');
                    },
                    error: function (xhr, status, error) {
                        console.error('ä¿å­˜å¤±è´¥', status, error);
                        console.log(xhr.responseText);
                        alert('ä¿å­˜å¤±è´¥');
                    }
                });
            } else if (target.classList.contains('delete-btn')) {
                let row = target.closest('tr');
                let task_id = row.cells[1].innerText.trim(); // ç¡®ä¿æ˜¯ä»»åŠ¡å•å·

                if (confirm('ä½ ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ')) {
                    $.ajax({
                        url: "{% url 'experiment:delete_task' %}",
                        method: "POST",
                        data: {
                            task_id: task_id, // ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function (response) {
                            console.log('åˆ é™¤æˆåŠŸ', response);
                            row.remove();
                        },
                        error: function (xhr, status, error) {
                            console.error('åˆ é™¤å¤±è´¥', status, error);
                            alert('åˆ é™¤å¤±è´¥');
                        }
                    });
                }
            } else if (target.classList.contains('cancel-btn')) {
                let row = target.closest('tr');
                row.remove();
                console.log('New row canceled');
            }
        });
    });
</script>

<style>
    .container[data-aos="fade-up"] {
        max-width: 1800px;
    }

    #task-table thead {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .starter-section input#search-input {
        max-width: 300px;
    }

    .edit-btn, .save-btn, .delete-btn, .cancel-btn {
        margin: 0 2px;
    }

    .table-select {
        width: 100%;
        height: 100%;
        padding: 0;
        border: none;
        box-shadow: none;
        background-color: transparent;
        font-size: inherit;
        line-height: inherit;
        font-family: inherit;
        text-align-last: center;
        box-sizing: border-box;
    }

    .outline-select {
        width: 100%;
        padding: 0;
        border: none;
        background-color: transparent;
        font-size: inherit;
        line-height: inherit;
        font-family: inherit;
        text-align-last: center;
        box-sizing: border-box;
    }

    #filter-date {
    max-width: 200px;
    margin-left: 10px;
    }

    .d-flex.flex-wrap {
        gap: 10px;
    }

    .form-check-inline {
        margin-right: 10px;
    }

    #filter-date {
        max-width: 200px;
    }

    /* ä»»åŠ¡é€‰æ‹©æ¨¡æ€çª—å£æ ·å¼ */
    #taskSelectionModal .modal-content {
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    #taskSelectionModal .modal-header {
        border-radius: 8px 8px 0 0;
        padding: 15px 20px;
    }

    #taskSelectionModal .modal-body {
        padding: 20px;
    }

    #taskSelectionModal .modal-title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
    }

    #taskSelectionModal .input-group {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        margin-bottom: 15px;
        /* å®½åº¦åœ¨HTMLå†…è”æ ·å¼ä¸­è®¾ç½® */
    }

    #task-search-input {
        padding: 8px 12px;
        font-size: 14px;
        height: 40px;
    }

    #task-search-btn {
        padding: 0 20px;
        font-weight: 500;
    }

    #task-application-table {
        width: 100%;
        margin-top: 10px;
        border: 1px solid #dee2e6;
    }

    #task-application-table thead th {
        background-color: #f8f9fa;
        padding: 12px 15px;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        border-bottom: 2px solid #dee2e6;
    }

    #task-application-table td {
        padding: 10px 15px;
        vertical-align: middle;
        border-bottom: 1px solid #eee;
        max-width: 250px;
    }

    #task-application-table tbody tr:hover {
        background-color: #f0f7ff;
    }

    .select-task-btn {
        border-radius: 4px;
        font-weight: 500;
        padding: 4px 12px;
        transition: all 0.2s ease;
        margin: 0 auto;
    }

    .select-task-btn:hover {
        background-color: #0056b3;
    }

    #taskSelectionModal .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #eee;
    }
    
    /* ç¡®ä¿è¡¨æ ¼æ˜¾ç¤ºåœ¨è§†å›¾ä¸­ */
    .table-responsive {
        overflow-x: auto;
        max-height: 60vh;
    }
</style>

{% endblock %}
