{% extends 'base.html' %}
{% load static %}

{% block content %}

<main class="main">
    <!-- Page Title -->
    <div class="page-title dark-background" style="background-image: url({% static 'images/info_banner.png' %});">
        <div class="container-fluid position-relative">
            <h1>{{ page_title }}</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a href="/">首页</a></li>
                    <li class="current"><a href="{% url 'equipment:equipment_medical_card' %}">设备管理 / </a>{{ page_title }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="container-fluid mt-4">
        <div class="card">
            <div class="card-body">
                <form id="filterForm" method="get" class="mb-4">
                    <div class="row justify-content-start">
                        <div class="col-md-12">
                            <div class="d-flex" style="gap: 8px;">
                                <div class="date-filters d-flex" style="gap: 8px;">
                                    <div class="input-group" style="width: 150px;">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <select name="year" class="form-select filter-select">
                                            <option value="">年份(全部)</option>
                                            {% for year in years %}
                                            <option value="{{ year }}" {% if year|stringformat:"i" == selected_year %}selected{% endif %}>
                                                {{ year }}年
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="input-group" style="width: 150px;">
                                        <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                                        <select name="month" class="form-select filter-select">
                                            <option value="">月份(全部)</option>
                                            {% for month in months %}
                                            <option value="{{ month }}" {% if month|stringformat:"i" == selected_month %}selected{% endif %}>
                                                {{ month }}月
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div style="width: 32px;"></div>  <!-- 添加间隔 -->
                                <div class="other-filters d-flex" style="gap: 8px;">
                                    <div class="input-group" style="width: 200px;">
                                        <span class="input-group-text"><i class="fas fa-microchip"></i></span>
                                        <select name="device_name" class="form-select filter-select">
                                            <option value="">设备编号(全部)</option>
                                            {% for device in device_names %}
                                            <option value="{{ device }}" {% if device == selected_device %}selected{% endif %}>
                                                {{ device }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="input-group" style="width: 200px;">
                                        <span class="input-group-text"><i class="fas fa-exclamation-triangle"></i></span>
                                        <select name="fault_level" class="form-select filter-select">
                                            <option value="">故障等级(全部)</option>
                                            {% for level in fault_levels %}
                                            <option value="{{ level }}" {% if level == selected_fault_level %}selected{% endif %}>
                                                {{ level }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="input-group" style="width: 200px;">
                                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                        <select name="fault_location" class="form-select filter-select">
                                            <option value="">故障位置(全部)</option>
                                            {% for location in fault_locations %}
                                            <option value="{{ location }}" {% if location == selected_fault_location %}selected{% endif %}>
                                                {{ location }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th style="text-align: center; width: 3%;">序号</th>
                                    <th style="text-align: center; width: 8%;">设备编号</th>
                                    <th style="text-align: center; width: 4%;">故障日期</th>
                                    <th style="text-align: center; width: 6%;">故障等级</th>
                                    <th style="text-align: center; width: 8%;">故障位置</th>
                                    <th style="text-align: center; width: 20%;">故障现象</th>
                                    <th style="text-align: center; width: 20%;">故障原因</th>
                                    <th style="text-align: center;">维修方法</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in repair_records %}
                                <tr>
                                    <td style="text-align: center;">{{ forloop.counter }}</td>
                                    <td>{{ record.equipment_id }}</td>
                                    <td>{{ record.application_date|date:"Y-m-d" }}</td>
                                    <td>{{ record.fault_level|default:"-" }}</td>
                                    <td>{{ record.fault_locations|default:"-" }}</td>
                                    <td>{{ record.fault_phenomenon }}</td>
                                    <td>{{ record.fault_reason|default:"-" }}</td>
                                    <td>{{ record.solution|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">暂无维修记录</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    /* 卡片样式优化 */
    .card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        margin-bottom: 20px;
        border: none;
    }

    .card-body {
        padding: 25px;
    }

    /* 筛选区域样式优化 */
    .form-select {
        padding: 8px 12px;
        font-size: 0.95rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        background-color: #fff;
        transition: all 0.3s ease;
        box-shadow: none;
        height: 40px;
    }

    .form-select:hover {
        border-color: #999;
    }

    .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
    }

    /* 表格样式优化 */
    .table {
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding: 12px 8px;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table td {
        padding: 12px 8px;
        vertical-align: middle;
        border-color: #e9ecef;
        font-size: 0.9rem;
        color: #333;
    }

    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.03);
    }

    /* 响应式布局优化 */
    @media (max-width: 768px) {
        .card-body {
            padding: 15px;
        }

        .form-select {
            margin-bottom: 10px;
        }
    }

    /* 滚动条美化 */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* 空数据提示样式 */
    .text-center {
        padding: 30px 0;
        color: #666;
        font-style: italic;
    }

    /* 筛选区域间距优化 */
    .row.align-items-center {
        gap: 15px;
        margin-bottom: 10px;
    }

    .col-md {
        padding: 0 8px;
    }

    /* 表格内容对齐和间距优化 */
    .table td:not(:first-child) {
        padding-left: 15px;
    }

    .table th:not(:first-child) {
        padding-left: 15px;
    }

    /* 序号列样式优化 */
    .table td:first-child {
        font-weight: 500;
        color: #495057;
        background-color: f8f9fa(0, 0, 0, 0.01);
        border: none;  /* 移除边框 */
    }

    /* 设备编号列样式 */
    .table td:nth-child(2) {
        color: #007bff;  /* 设置蓝色 */
        font-weight: 500;
    }

    /* 新增和修改的样式 */
    .input-group {
        margin-bottom: 0;  /* 移除底部间距 */
        flex-shrink: 0;    /* 防止压缩 */
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #ddd;
        color: #495057;
        width: 40px;
        justify-content: center;
    }

    .input-group-text i {
        font-size: 0.9rem;
    }

    .form-select {
        border-left: 0;
    }

    .input-group .form-select:focus {
        border-left: 1px solid #007bff;
    }

    /* 确保图标颜色与主题一致 */
    .fa-microchip { color: #0d6efd; }
    .fa-exclamation-triangle { color: #dc3545; }
    .fa-map-marker-alt { color: #198754; }
    .fa-calendar-alt { color: #6610f2; }
    .fa-calendar-day { color: #fd7e14; }

    /* 修改筛选区域样式 */
    .d-flex.gap-2 {
        flex-wrap: nowrap;
    }

    .filter-select {
        width: auto;       /* 允许内容决定宽度 */
    }

    .date-filters {
        display: flex;
        align-items: center;
    }

    .other-filters {
        display: flex;
        align-items: center;
    }

    /* 响应式布局调整 */
    @media (max-width: 1200px) {
        .d-flex.gap-2 {
            flex-wrap: wrap;
        }
        .input-group {
            margin-bottom: 10px;
        }
    }

    /* 表格容器和滚动相关样式 */
    .table-wrapper {
        position: relative;
        margin-top: 20px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        height: calc(65vh);  /* 修改为视窗高度的65% */
        display: flex;
        flex-direction: column;
    }

    .table-scroll {
        flex: 1;
        overflow-y: auto;
        overflow-x: auto;
        position: relative;
    }

    .table {
        margin: 0;
        border: none;
        width: 100%;
    }

    /* 固定表头样式 */
    .table thead {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #f8f9fa;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    }

    /* 表格内容样式优化 */
    .table tbody {
        position: relative;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    /* 滚动条样式优化 */
    .table-scroll::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .table-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
        background: #aaa;
        border-radius: 3px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
        background: #888;
    }

    /* 确保表格单元格内容不会换行 */
    .table td, .table th {
        white-space: nowrap;
        padding: 12px 8px;
    }

    /* 表格行样式优化 */
    .table tbody tr:last-child td {
        border-bottom: none;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 获取所有筛选下拉框
    const filterSelects = document.querySelectorAll('.filter-select');
    
    // 为每个下拉框添加change事件监听器
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            // 直接提交表单，触发页面刷新
            document.getElementById('filterForm').submit();
        });
    });
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

{% endblock %}
